<!doctype html><html lang="en"><head><meta charset="utf-8"> <title>Amazon S3 × CloudFront - digital authority</title> <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"> <meta name="description" content="Previously this site was hosted on a Linode VPS, handling thousands of requests a day. It’s stable, fast, and has a great support team. But this time I would like to try something new - host my website entirely in..."> <meta name="theme-color" content="#a212d1"> <link rel="alternate" href="/feed.xml" type="application/atom+xml"> <link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="icon" href="/favicon.png" type="image/png"><link rel="icon" href="data:image/svg+xml;utf8,%3Csvg%20width%3D'180'%20height%3D'180'%20viewBox%3D'0%200%20180%20180'%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20xmlns%3Axlink%3D'http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink'%3E%3Ctitle%3ESparanoid%3C%2Ftitle%3E%3Cdefs%3E%3Cpath%20d%3D'M90%20165c41.42%200%2075-33.58%2075-75s-33.58-75-75-75-75%2033.58-75%2075%2033.58%2075%2075%2075zm0-10c35.9%200%2065-29.1%2065-65s-29.1-65-65-65-65%2029.1-65%2065%2029.1%2065%2065%2065zm0-4.167c33.597%200%2060.833-27.236%2060.833-60.833%200-33.597-27.236-60.833-60.833-60.833-33.597%200-60.833%2027.236-60.833%2060.833%200%2033.597%2027.236%2060.833%2060.833%2060.833zm0-18.333c23.472%200%2042.5-19.028%2042.5-42.5S113.472%2047.5%2090%2047.5%2047.5%2066.528%2047.5%2090s19.028%2042.5%2042.5%2042.5z'%20id%3D'a'%2F%3E%3C%2Fdefs%3E%3Cg%20fill%3D'none'%20fill-rule%3D'evenodd'%3E%3Ccircle%20fill%3D'%23FFF'%20cx%3D'90'%20cy%3D'90'%20r%3D'90'%2F%3E%3Cmask%20id%3D'b'%20fill%3D'%23fff'%3E%3Cuse%20xlink%3Ahref%3D'%23a'%2F%3E%3C%2Fmask%3E%3Cuse%20fill%3D'%23A212D1'%20xlink%3Ahref%3D'%23a'%2F%3E%3Cpath%20d%3D'M0%200h180v180H0z'%20mask%3D'url(%23b)'%20fill%3D'%23A212D1'%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E" sizes="any" type="image/svg+xml"><link rel="mask-icon" href="/mask-icon.svg" color="#a212d1"> <link rel="manifest" href="/manifest.json"> <style>:root{--fontstack-prefix:-apple-system,BlinkMacSystemFont,;--fontstack-sans-serif:"Helvetica Neue","Segoe UI",sans-serif;--fontstack-serif:Georgia,serif;--fontstack-monospace:Menlo,Consolas,monospace;--fontstack-default:var(--fontstack-prefix) var(--fontstack-sans-serif);--font-size-base:1rem;--font-size-factor:1vw;--font-size:1.6vw;--font-features:"halt","ss01","ss02";--line-height:calc(20 / 14);--heading-letter-spacing:-.04em;--breakpoint-lg:1600px;--breakpoint-md:1080px;--breakpoint-sm:640px;--breakpoint-xs:400px;--space-lg:24vw;--space-md:8vw;--space-sm:4vw;--space-xs:1.2vw;--border-lg:4px;--border-md:2px;--border-sm:1px;--nav-padding:.75vmax;--nav-item-space:1.4vmax;--text-color-h:318;--text-color-s:30%;--text-color-l:10%;--text-color-hsl:var(--text-color-h),var(--text-color-s),var(--text-color-l);--text-color:hsl(var(--text-color-hsl));--text-color-0:hsla(var(--text-color-hsl), 0);--text-color-3:hsla(var(--text-color-hsl), .03);--text-color-5:hsla(var(--text-color-hsl), .05);--text-color-7:hsla(var(--text-color-hsl), .07);--text-color-10:hsla(var(--text-color-hsl), .1);--text-color-20:hsla(var(--text-color-hsl), .2);--text-color-30:hsla(var(--text-color-hsl), .3);--text-color-40:hsla(var(--text-color-hsl), .4);--text-color-50:hsla(var(--text-color-hsl), .5);--text-color-60:hsla(var(--text-color-hsl), .6);--text-color-70:hsla(var(--text-color-hsl), .7);--text-color-80:hsla(var(--text-color-hsl), .8);--text-color-90:hsla(var(--text-color-hsl), .9);--text-color-light:hsl(var(--text-color-h), var(--text-color-s), calc(var(--text-color-l) / .9));--text-color-dark:hsl(var(--text-color-h), var(--text-color-s), calc(var(--text-color-l) * .9));--link-color-h:318;--link-color-s:100%;--link-color-l:50%;--link-color-hsl:var(--link-color-h),var(--link-color-s),var(--link-color-l);--link-color:hsl(var(--link-color-hsl));--link-color-0:hsla(var(--link-color-hsl), 0);--link-color-3:hsla(var(--link-color-hsl), .03);--link-color-5:hsla(var(--link-color-hsl), .05);--link-color-7:hsla(var(--link-color-hsl), .07);--link-color-10:hsla(var(--link-color-hsl), .1);--link-color-20:hsla(var(--link-color-hsl), .2);--link-color-30:hsla(var(--link-color-hsl), .3);--link-color-40:hsla(var(--link-color-hsl), .4);--link-color-50:hsla(var(--link-color-hsl), .5);--link-color-60:hsla(var(--link-color-hsl), .6);--link-color-70:hsla(var(--link-color-hsl), .7);--link-color-80:hsla(var(--link-color-hsl), .8);--link-color-90:hsla(var(--link-color-hsl), .9);--link-color-light:hsl(var(--link-color-h), var(--link-color-s), calc(var(--link-color-l) / .9));--link-color-dark:hsl(var(--link-color-h), var(--link-color-s), calc(var(--link-color-l) * .9));--bg-color-h:318;--bg-color-s:30%;--bg-color-l:100%;--bg-color-hsl:var(--bg-color-h),var(--bg-color-s),var(--bg-color-l);--bg-color:hsl(var(--bg-color-hsl));--bg-color-0:hsla(var(--bg-color-hsl), 0);--bg-color-3:hsla(var(--bg-color-hsl), .03);--bg-color-5:hsla(var(--bg-color-hsl), .05);--bg-color-7:hsla(var(--bg-color-hsl), .07);--bg-color-10:hsla(var(--bg-color-hsl), .1);--bg-color-20:hsla(var(--bg-color-hsl), .2);--bg-color-30:hsla(var(--bg-color-hsl), .3);--bg-color-40:hsla(var(--bg-color-hsl), .4);--bg-color-50:hsla(var(--bg-color-hsl), .5);--bg-color-60:hsla(var(--bg-color-hsl), .6);--bg-color-70:hsla(var(--bg-color-hsl), .7);--bg-color-80:hsla(var(--bg-color-hsl), .8);--bg-color-90:hsla(var(--bg-color-hsl), .9);--bg-color-light:hsl(var(--bg-color-h), var(--bg-color-s), calc(var(--bg-color-l) / .9));--bg-color-dark:hsl(var(--bg-color-h), var(--bg-color-s), calc(var(--bg-color-l) * .9));--code-color-h:calc(var(--link-color-h) + 30);--code-color-s:calc(var(--link-color-s) * .2 + 30%);--code-color-l:var(--link-color-l);--code-color-hsl:var(--code-color-h),var(--code-color-s),var(--code-color-l);--code-color:hsl(var(--code-color-hsl));--code-color-0:hsla(var(--code-color-hsl), 0);--code-color-3:hsla(var(--code-color-hsl), .03);--code-color-5:hsla(var(--code-color-hsl), .05);--code-color-7:hsla(var(--code-color-hsl), .07);--code-color-10:hsla(var(--code-color-hsl), .1);--code-color-20:hsla(var(--code-color-hsl), .2);--code-color-30:hsla(var(--code-color-hsl), .3);--code-color-40:hsla(var(--code-color-hsl), .4);--code-color-50:hsla(var(--code-color-hsl), .5);--code-color-60:hsla(var(--code-color-hsl), .6);--code-color-70:hsla(var(--code-color-hsl), .7);--code-color-80:hsla(var(--code-color-hsl), .8);--code-color-90:hsla(var(--code-color-hsl), .9);--code-color-light:hsl(var(--code-color-h), var(--code-color-s), calc(var(--code-color-l) / .9));--code-color-dark:hsl(var(--code-color-h), var(--code-color-s), calc(var(--code-color-l) * .9))}*,::after,::before{padding:0;margin:0;box-sizing:border-box}html{font-size:100%;-webkit-text-size-adjust:none;-ms-text-size-adjust:none;text-size-adjust:none;text-rendering:optimizelegibility;image-rendering:optimizequality;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:var(--bg-color)}body{--space-body:var(--space-lg);padding-top:0;padding-bottom:0;padding-left:var(--space-body);padding-right:var(--space-body);margin:0 auto 0;font-family:var(--fontstack-default);font-size:var(--font-size);-webkit-font-feature-settings:var(--font-features);font-feature-settings:var(--font-features);line-height:var(--line-height);hanging-punctuation:first allow-end;color:var(--text-color);background:var(--bg-color);-webkit-transition:all .2s ease;transition:all .2s ease}@media (max-width:1080px){body{--space-body:var(--space-md);font-size:calc(var(--font-size) * 1.4)}}@media (max-width:640px){body{--space-body:var(--space-sm);font-size:calc(var(--font-size) * 2.4)}}@media (max-width:400px){body{font-size:calc(var(--font-size) * 3.2)}}a{color:var(--text-color);text-decoration:none;-webkit-transition:color .5s ease,border-color .5s ease,background .5s ease,opacity 1.5s ease;transition:color .5s ease,border-color .5s ease,background .5s ease,opacity 1.5s ease}a:focus,a:hover{-webkit-transition:color .1s ease,border-color .1s ease,background .1s ease,opacity .1s ease;transition:color .1s ease,border-color .1s ease,background .1s ease,opacity .1s ease;text-decoration:underline}::-webkit-input-placeholder{color:var(--text-color);opacity:.2}::-moz-placeholder{color:var(--text-color);opacity:.2}:-ms-input-placeholder{color:var(--text-color);opacity:.2}::-ms-input-placeholder{color:var(--text-color);opacity:.2}:focus::-webkit-input-placeholder{color:var(--link-color)}:focus::-moz-placeholder{color:var(--link-color)}:focus:-ms-input-placeholder{color:var(--link-color)}:focus::-ms-input-placeholder{color:var(--link-color)}.navigation{padding-top:var(--nav-padding);padding-bottom:var(--nav-padding);margin-right:calc(var(--nav-item-space) * -1);margin-left:calc(var(--nav-item-space) * -1);font-size:90%;font-weight:700}.navigation li{display:inline-block;line-height:2}.navigation li a{padding:.5em var(--nav-item-space)}.navigation li a:focus,.navigation li a:hover{color:var(--link-color);text-decoration:none}.content{margin-bottom:16vmin}.content::after,.content::before{display:table;content:""}.content::after{clear:both}.content article>:last-child{margin-bottom:0!important}.content article>:last-child>:last-child{margin-bottom:0!important}.content article>:last-child>:last-child>:last-child{margin-bottom:0!important}.content article>:last-child>:last-child>:last-child>:last-child{margin-bottom:0!important}.content .post-content>:first-child{margin-top:0}.content a{font-weight:700}.content a:has(>code){-webkit-text-decoration-color:var(--code-color);text-decoration-color:var(--code-color)}.content p{margin-bottom:1.6rem;line-height:calc(var(--line-height) * 1.2)}.content header{--header-height:100vh;--space-header:var(--space-lg);display:-webkit-box;display:flex;min-height:calc(var(--header-height) - (var(--nav-padding) * 4) - (var(--nav-item-space) * 4) - (1ex * .9 * 2));padding-top:10vmin;padding-bottom:10vmin;margin-bottom:16vmin;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-box-pack:center;justify-content:center;background:var(--text-color-3);padding-left:var(--space-header);padding-right:var(--space-header);margin-left:calc(var(--space-header) * -1);margin-right:calc(var(--space-header) * -1)}@media (max-width:1080px){.content header{--header-height:70vh;--space-header:var(--space-md);padding-top:16vmin;padding-bottom:16vmin}}@media (max-width:640px){.content header{--space-header:var(--space-sm)}}.content header h1{font-size:360%;font-weight:700;letter-spacing:var(--heading-letter-spacing);margin-left:-2px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.1}@media (max-width:640px){.content header h1{font-size:280%}}.content header small{display:block;margin-top:2vmin}.content h3{margin:10vmin 0 1rem;font-size:72%;font-weight:400;opacity:.5}.content ol,.content ul{margin-bottom:1.8rem;list-style:none;counter-reset:list}@media (max-width:640px){.content ol,.content ul{margin-left:1em}}.content ol li,.content ul li{line-height:calc(var(--line-height) * 1.2)}.content ol li::before,.content ul li::before{position:absolute;display:-webkit-box;display:flex;-webkit-box-pack:end;justify-content:flex-end;width:4em;margin-top:0;margin-left:-4em;text-align:right;opacity:.4;pointer-events:none}.content ul li::before{content:"-";padding-right:.5em}.content ol li::before{counter-increment:list;content:counter(list) ".";padding-right:.25em}.content blockquote{position:relative;margin-bottom:2.8rem;margin-left:calc(var(--space-xs) * -1);font-size:90%}@media (max-width:640px){.content blockquote{margin-left:0}}.content blockquote>p{padding-left:var(--space-xs);border-left:var(--border-md) solid;color:var(--text-color-60);padding-bottom:1.6em;margin-bottom:0}.content blockquote>p:last-of-type{padding-bottom:0;margin-bottom:.4em}@media (max-width:640px){.content blockquote>p{padding-left:calc(var(--space-sm) - var(--border-md));padding-right:var(--space-sm);margin-left:calc(var(--space-sm) * -1);margin-right:calc(var(--space-sm) * -1)}}.content sup{font-size:75%}.content code,.content pre{font-family:var(--fontstack-monospace);color:var(--code-color)}.content pre{background:var(--code-color-5)}.content code{font-size:92%;overflow-wrap:break-word}.content .highlight>pre,.content .highlighter-rouge pre.highlight,.content pre{--space-code:var(--space-xs);padding-top:var(--space-xs);padding-bottom:var(--space-xs);padding-left:var(--space-code);padding-right:var(--space-code);margin-left:calc(var(--space-code) * -1);margin-right:calc(var(--space-code) * -1);margin-bottom:1.8rem;overflow-x:auto;font-size:80%;line-height:calc(var(--line-height) * 1.2);-webkit-overflow-scrolling:touch}@media (max-width:1080px){.content .highlight>pre,.content .highlighter-rouge pre.highlight,.content pre{--space-code:var(--space-md)}}@media (max-width:640px){.content .highlight>pre,.content .highlighter-rouge pre.highlight,.content pre{--space-code:var(--space-sm)}}.content .highlight>pre code,.content .highlighter-rouge pre.highlight code,.content pre code{overflow-wrap:normal}.post-modified-date{font-size:75%;opacity:.5}.footnotes{font-size:80%}.footnotes::before{display:block;content:'';width:3px;height:3px;margin:2em auto;border-radius:50%;background:var(--text-color);box-shadow:24px 0 0 0 var(--text-color),-24px 0 0 0 var(--text-color)}:target .footnote,:target .reversefootnote{color:var(--link-color)}.of-case{-webkit-font-feature-settings:"case";font-feature-settings:"case"}.footer{padding:0 0 16vmin;margin-right:calc(var(--nav-item-space) * -1);margin-left:calc(var(--nav-item-space) * -1);font-size:80%;text-transform:lowercase}.footer ul li{display:inline-block;line-height:1.8}.footer ul li a{padding:.5em var(--nav-item-space)}@media print{*,::after,::before{background:0 0!important;color:#000!important;box-shadow:none!important;text-shadow:none!important}body{padding:10mm!important;margin:0!important;font-size:calc(var(--font-size) * 1.35)}a,a:visited{text-decoration:none}.content header{min-height:0;padding-bottom:0}.content .post-content{max-width:100%!important}.content .post-content a[href]::after{content:" (" attr(href) ")";font-weight:400;opacity:.5}.content .post-content a[href^="#"]::after{content:""}blockquote,pre{page-break-inside:avoid}h3,p{orphans:3;widows:3}h3{page-break-after:avoid}.footer,.navigation{display:none}}:root{--rdmz-h:var(--code-color-h, 254);--rdmz-s:var(--code-color-s, 80%);--rdmz-l:var(--code-color-l, 39%)}.highlight>pre,.highlighter-rouge pre.highlight{background:hsla(var(--rdmz-h),var(--rdmz-s),var(--rdmz-l),.03)}.highlight .o,.highlighter-rouge .o{font-weight:700}.highlight code,.highlight pre,.highlighter-rouge code,.highlighter-rouge pre{--rdmz-h-local:var(--rdmz-h);color:hsl(var(--rdmz-h),var(--rdmz-s),var(--rdmz-l))}.highlight .na,.highlighter-rouge .na{--rdmz-h-local:calc(var(--rdmz-h) + 21.4925373134);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .nb,.highlighter-rouge .nb{--rdmz-h-local:calc(var(--rdmz-h) + 26.8656716418);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .nl,.highlighter-rouge .nl{--rdmz-h-local:calc(var(--rdmz-h) + 69.8507462687);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .nt,.highlighter-rouge .nt{--rdmz-h-local:calc(var(--rdmz-h) + 85.9701492537);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .nv,.highlighter-rouge .nv{--rdmz-h-local:calc(var(--rdmz-h) + 91.3432835821);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .w,.highlighter-rouge .w{--rdmz-h-local:calc(var(--rdmz-h) + 220.298507463);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .s,.highlighter-rouge .s{--rdmz-h-local:calc(var(--rdmz-h) + 236.417910448);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .s2,.highlighter-rouge .s2{--rdmz-h-local:calc(var(--rdmz-h) + 257.910447761);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .m,.highlighter-rouge .m{--rdmz-h-local:calc(var(--rdmz-h) + 300.895522388);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .o,.highlighter-rouge .o{--rdmz-h-local:calc(var(--rdmz-h) + 343.880597015);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .p,.highlighter-rouge .p{--rdmz-h-local:calc(var(--rdmz-h) + 354.626865672);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}.highlight .pi,.highlighter-rouge .pi{--rdmz-h-local:calc(var(--rdmz-h) + 360);color:hsl(var(--rdmz-h-local),var(--rdmz-s),var(--rdmz-l))}:root{--fontstack-sans-serif:"Helvetica Neue","Segoe UI","Hiragino Sans GB",sans-serif;--fontstack-serif:Georgia,"Hiragino Mincho ProN",serif}:root{--link-color-h:285;--link-color-s:84%;--link-color-l:45%;--text-color-h:var(--link-color-h);--bg-color-h:var(--link-color-h)}</style> <link rel="canonical" href="https://digitalauthority.com.au//note/amazon-s3-cloudfront/"> <meta property="og:type" content="article"> <meta property="og:site_name" content="digital authority"> <meta property="og:title" content="Amazon S3 × CloudFront"> <meta property="og:url" content="https://digitalauthority.com.au//note/amazon-s3-cloudfront/"> <meta property="og:description" content="Previously this site was hosted on a Linode VPS, handling thousands of requests a day. It’s stable, fast, and has a great support team. But this time I would like to try something new - host my website entirely in..."> <meta property="og:image" content="https://digitalauthority.com.au//logo.png"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@ynnmedianetwork"> <meta name="twitter:creator" content="@youthsnews"> <meta property="article:published_time" content="2015-04-27T00:00:00+08:00"> <meta property="article:modified_time" content="2019-06-15T13:09:07+08:00"> <meta name="twitter:label1" value="Words"> <meta name="twitter:data1" value="1300 words"> <meta name="twitter:label2" value="Reading time"> <meta name="twitter:data2" value="6 mins"> </head><body><nav class="navigation"> <ul> <li> <a href="/">digital authority</a> </li> <li> <a href="/work/">Work</a> </li> <li> <a href="/note/">Consultant</a> </li> <li> <a href="/about/">About</a> </li> </ul> </nav> <main class="content" role="main"> <article lang="en"> <header> <h1 title="Amazon S3 × CloudFront" data-title="Amazon S3 × CloudFront"> Amazon S3 <span class="of-case">×</span> CloudFront<span class="dot dot--post"> </span> </h1> <small> By <span rel="author">digital</span> on <time datetime="2015-04-27T00:00:00+08:00">Apr 27, 2015</time> </small> </header> <div class="post-content"> <p>Previously this site was hosted on a Linode VPS, handling thousands of requests a day. It’s stable, fast, and has a great support team. But this time I would like to try something new - host my website entirely in the cloud.</p> <p>The first cloud provider that came to my mind was Amazon S3 and CloudFront. Back in 2010, I tried this combination with no luck. The web hosting feature of S3 was not as expected, and CloudFront did not support custom domain SSL and the apex (root) domain was also not supported. But now I’m happy to see all these features implemented and so I’m going to try this approach again.</p> <p>Please note that this is not a detailed tutorial about how to host your website on Amazon S3 and CloudFront, but my personal notes about setup pitfalls.</p> <h3 id="transfer-everything-to-the-cloud">Transfer everything to the Cloud?</h3> <p>There are two methods you can choose - host static files on Amazon S3 and speed up using CloudFront, or host your website on a remote server using CloudFront as custom origin proxy. Both of these have their pros and cons:</p> <p>Amazon S3 + CloudFront means you do not have to buy additional servers to host your website, but you have to do more work to ensure your website behaves the same as before. For example, you cannot use <code class="highlighter-rouge">/feed/</code> (<code class="highlighter-rouge">/feed/index.xml</code>) as your feed URL because you can set only one Document Index per bucket. If you’re using <code class="highlighter-rouge">/feed/</code> then you have to redirect it to something similar to <code class="highlighter-rouge">feed.xml</code>. Gzip is also not a native feature on S3. You have to compress it manually or use other tools (I will talk about it later).</p> <p>Update Dec 19, 2015: Amazon finally added <a href="https://aws.amazon.com/blogs/aws/new-gzip-compression-support-for-amazon-cloudfront/">Gzip compression support for CloudFront</a>. You can now simply turn on this feature in AWS console or via CLI.</p> <p>Using Amazon CloudFront with custom origin means you still need servers to store your files. You will have more control with your website, for example, you can use Nginx with complex redirects, your website can be dynamic, and CloudFront works just like a proxy. However, the downside is the cache control which can be tricky. You cannot use invalidation with the existing tools and you have to set separate cache control headers <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html"><code class="highlighter-rouge">s-maxage</code></a> for CloudFront.</p> <p>To make things simple, I use Amazon S3 with CloudFront.</p> <h3 id="move-files-to-amazon-s3">Move files to Amazon S3</h3> <p>The easiest way is using <a href="https://github.com/laurilehmijoki/s3_website">s3_website</a>. It can help you handle file headers, invalidations, and redirects.</p> <p>Here’s a part of my <code class="highlighter-rouge">s3_website.yml</code> config:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">s3_bucket</span><span class="pi">:</span> <span class="s">sparanoid.com</span>
<span class="na">max_age</span><span class="pi">:</span>
  <span class="s2">"</span><span class="s">index.html"</span><span class="pi">:</span> <span class="m">600</span>
  <span class="s2">"</span><span class="s">*.css"</span><span class="pi">:</span>      <span class="m">2592000</span>
  <span class="s2">"</span><span class="s">*.js"</span><span class="pi">:</span>       <span class="m">2592000</span>
  <span class="s2">"</span><span class="s">*.jpg"</span><span class="pi">:</span>      <span class="m">31536000</span>
  <span class="s2">"</span><span class="s">*.woff2"</span><span class="pi">:</span>    <span class="m">31536000</span>
  <span class="s2">"</span><span class="s">*"</span><span class="pi">:</span>          <span class="m">86400</span>
</code></pre></div></div> <p>You can also define the files to be ignored:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">exclude_from_upload</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">(?:\.(?:DS_Store|bak|config|sql|fla|psd|ai|sketch|ini|log|sh|inc|swp|dist))$</span>
</code></pre></div></div> <p>For more information please refer <code class="highlighter-rouge">s3_website</code>’s <a href="https://github.com/laurilehmijoki/s3_website">documentation</a>.</p> <h3 id="fixing-wrong-feed-url">Fixing wrong feed URL</h3> <p>As discussed before, you cannot use <code class="highlighter-rouge">/feed/</code> (<code class="highlighter-rouge">/feed/index.xml</code>) as your feed URL because you can set only one Document Index per bucket. Amazon S3 does not redirect it to a file other than Document Index (i.e. <code class="highlighter-rouge">index.html</code>). You have to make a redirect from <code class="highlighter-rouge">/feed/</code> or <code class="highlighter-rouge">/rss/</code> to <code class="highlighter-rouge">feed.xml</code> or <code class="highlighter-rouge">rss.xml</code> that directly points to the file. This is performed by the following two steps:</p> <p>First redirect <code class="highlighter-rouge">/feed</code> to <code class="highlighter-rouge">/feed.xml</code> in <code class="highlighter-rouge">s3_website.yml</code>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">redirects</span><span class="pi">:</span>
  <span class="na">feed</span><span class="pi">:</span> <span class="s">feed.xml</span>
</code></pre></div></div> <p>Then redirect <code class="highlighter-rouge">/feed/</code> to <code class="highlighter-rouge">/feed.xml</code> in AWS web console:</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;RoutingRules&gt;</span>
    <span class="nt">&lt;RoutingRule&gt;</span>
        <span class="nt">&lt;Condition&gt;</span>
            <span class="nt">&lt;KeyPrefixEquals&gt;</span>feed/<span class="nt">&lt;/KeyPrefixEquals&gt;</span>
        <span class="nt">&lt;/Condition&gt;</span>
        <span class="nt">&lt;Redirect&gt;</span>
            <span class="nt">&lt;HostName&gt;</span>sparanoid.com<span class="nt">&lt;/HostName&gt;</span>
            <span class="nt">&lt;ReplaceKeyPrefixWith&gt;</span>feed.xml<span class="nt">&lt;/ReplaceKeyPrefixWith&gt;</span>
        <span class="nt">&lt;/Redirect&gt;</span>
    <span class="nt">&lt;/RoutingRule&gt;</span>
<span class="nt">&lt;/RoutingRules&gt;</span>
</code></pre></div></div> <p>Update Sep 11, 2015: actually you can define routing rules directly in <code class="highlighter-rouge">s3_website.yml</code>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">routing_rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span>
      <span class="na">key_prefix_equals</span><span class="pi">:</span> <span class="s">feed/</span>
    <span class="na">redirect</span><span class="pi">:</span>
      <span class="na">host_name</span><span class="pi">:</span> <span class="s">sparanoid.com</span>
      <span class="na">replace_key_prefix_with</span><span class="pi">:</span> <span class="s">feed.xml</span>
      <span class="na">http_redirect_code</span><span class="pi">:</span> <span class="m">301</span>
</code></pre></div></div> <p>Then run <code class="highlighter-rouge">s3_website cfg apply</code> to update redirects.</p> <h3 id="redirect-www-to-non-www">Redirect www to non-www</h3> <p>You have to create an empty separate S3 bucket and redirect all requests to your root domain. Refer <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html#root-domain-walkthrough-s3-tasks">official documentation</a>. This can be set under your bucket properties panel.</p> <h3 id="enable-cloudfront">Enable CloudFront</h3> <p>The only thing you should be aware of is that the Origin Domain Name should be pointing to your S3 endpoint and not to the bucket URL.</p> <h3 id="cloudfront--custom-ssl">CloudFront + Custom SSL</h3> <p>Update: As of Jan 21, 2016, you can now use Amazon CloudFront Integrates with AWS Certificate Manager (More like a Let’s Encrypt competitor focused on AWS), which can help you issue, manage, and renew SSL/TLS certificates at no extra cost.</p> <p>The following is the deprecated IAM method:</p> <p>Amazon has a <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/SecureConnections.html">very detailed documentation</a> about using HTTPS with custom SSL certificates and it’s hard to get the key points. So here’s a brief answer:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws iam upload-server-certificate <span class="nt">--server-certificate-name</span> sparanoid.com <span class="nt">--certificate-body</span> file:///path/cert.crt <span class="nt">--private-key</span> file:///path/private.key.pem <span class="nt">--certificate-chain</span> file:///path/intermediates.chained.crt <span class="nt">--path</span> /cloudfront/prod/
</code></pre></div></div> <p>Please note that <code class="highlighter-rouge">private-key</code> should be in PEM format. If you get the following error:</p> <blockquote> <p>A client error (MalformedCertificate) occurred when calling the UploadServerCertificate operation: Unable to parse certificate. Please ensure the certificate is in PEM format.</p> </blockquote> <p>Then try:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl rsa <span class="nt">-in</span> private.key <span class="nt">-out</span> private.key.pem
</code></pre></div></div> <p>If you get the following message, then it must be something wrong with your chained intermediate certificates:</p> <blockquote> <p>A client error (MalformedCertificate) occurred when calling the UploadServerCertificate operation: Unable to validate certificate chain. The certificate chain must start with the immediate signing certificate, followed by any intermediaries in order. The index within the chain of the invalid certificate is: 1</p> </blockquote> <p>The fix is simple - you should only chain your intermediate certificates <strong>without</strong> the domain certificate and this is different with the Nginx <code class="highlighter-rouge">ssl_certificate</code> directive:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt <span class="o">&gt;</span> intermediates.chained.crt
</code></pre></div></div> <p>Please also note that all certs should start with <code class="highlighter-rouge">file://</code> protocol if they’re on your local machine.</p> <p>If everything is right you will get the following response:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"ServerCertificateMetadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ServerCertificateId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ASCAxxxxxxxxxxxxxxZ7S"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ServerCertificateName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sparanoid.com"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Expiration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-04-26T23:59:59Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/cloudfront/prod/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Arn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::677998837349:server-certificate/cloudfront/prod/sparanoid.com"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"UploadDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-04-27T03:54:45.807Z"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Then you can enable the Custom SSL Certificate stored in your AWS IAM from the web console.</p> <p>Notes:</p> <ul> <li>The size of the public key in the SSL certificate cannot exceed 2048 bits <sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>.</li> <li>As of October of 2015, you still can’t use ECC certificate (ECDSA cipher suites) for CloudFront <sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>.</li> </ul> <h3 id="update-ssl-certificate">Update SSL Certificate</h3> <p>If the certificate you’re using is expiring, you need first upload the new certificate with a different <code class="highlighter-rouge">server-certificate-name</code>, change the expiring certificate to the new one, then you can optionally remove the old certificate with <code class="highlighter-rouge">aws iam delete-server-certificate</code>. You can also list all existing certificates via <code class="highlighter-rouge">aws iam list-server-certificates</code>.</p> <div class="footnotes"> <ol> <li id="fn:1"> <p>See “Determining the Size of the Public Key in an SSL Certificate” section in <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/SecureConnections.html">Using an HTTPS Connection to Access Your Objects - Amazon CloudFront</a>&nbsp;<a href="#fnref:1" class="reversefootnote">↩︎</a></p> </li> <li id="fn:2"> <p>See “Encryption” in <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html">Request and Response Behavior for Custom Origins - Amazon CloudFront</a>&nbsp;<a href="#fnref:2" class="reversefootnote">↩︎</a></p> </li> </ol> </div> <footer class="post-modified-date"> <p> Updated <time datetime=" 2019-06-15T13:09:07+08:00 "> Saturday, Jun 15, 2019 </time> </p> </footer> </div> </article> </main> <footer class="footer"> <ul> <li><a href="/">digital authority</a></li> <li> <a href="https://sparanoid.com/lab/amsf/" title="Almace Scaffolding with theme Curtana">AMSF</a> </li> <li> <a href="https://marketin.com.au/">Marketin.com.au</a> </li> </ul> </footer> <script></script> <script></script> <script>"serviceWorker"in navigator&&"digitalauthority.com.au"===window.location.hostname&&navigator.serviceWorker.register("/service-worker.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}).catch(function(e){console.log("ServiceWorker registration failed: ",e)})</script></body></html>